#  Smart Car  



##  1. 개요

### 
STM32, Arduino, Raspberry Pi, MariaDB를 이용하여 전방 장애물 거리에 따라 차량 속도를 자동 제어, 속도 및 거리 등 운행 정보를 서버DB에 실시간 전송 및 저장하고 모니터링하는 안전 시스템 개발

---

##  2. 구성도 (System Architecture)


<img width="1283" height="639" alt="흐름도" src="https://github.com/user-attachments/assets/e50b1777-bfa9-469c-a416-0fb383daab21" />


* **STM32 :** 초음파 센서로 거리 측정, PID 알고리즘을 통한 DC 모터 속도 제어, 블루투스를 통한 데이터 송신
* **Raspberry Pi :** 중앙 제어 서버, 이기종 디바이스(STM32↔Arduino) 간 데이터 중계 및 처리 
* **MariaDB:** 차량 ID, 모터 상태, 거리, 속도, 시간 등의 주행 로그 데이터 저장 
* **Arduino :** 상황실 현재 차량 상태(속도, 거리) LCD 표시 및 안전 거리 경고등(LED) 표시 



---

##  3. 기능 설명

### 장애물 거리에 따른 모터 제어(STM)
<img width="833" height="391" alt="STM32" src="https://github.com/user-attachments/assets/9f62459b-ae32-4fc5-aaf7-edd4c424fb3d" />

초음파 센서로 전방 장애물 거리를 측정하여, 거리별 목표속도를 설정하고, 엔코더 센서 피드백 기반의 PID 제어를 통해 해당 속도를 조절

1.  **10cm 미만:** 목표 속도 0 설정 (강제 정지)
2.  **10cm ~ 30cm:** 거리에 따른 비례 제어(PID)를 적용하여 오차 변화량을 예측하고 속도를 부드럽게 감속/가속 
3.  **30cm 초과:** 최대 목표 속도 유지 (정속 주행)

### 데이터 전송 (Server & DB)
<img width="1272" height="588" alt="데이터" src="https://github.com/user-attachments/assets/43c7da83-f1f8-4945-8461-22f3a84d7d64" />

TCP/IP 소켓 통신을 이용한 DB 데이터 전송  
Wi-Fi / Bluetooth 인터페이스로 데이터를 전송받아 MariaDB에 자동 기록
1. **실시간 통신:** 1초마다 데이터를 요청하고 송수신하여 딜레이 없는 제어 환경 구축 
2. **로그 저장:** `car_table`에 차량 ID(car_id), 모터값(car_motor), 거리(car_distance), 속도(car_speed), 날짜/시간 등을 기록하여 사고 분석 데이터로 활용 

### 데이터 모니터링 (Arduino)
<img width="1302" height="593" alt="아두이노" src="https://github.com/user-attachments/assets/ed09d8d0-dc37-493a-8078-dacf7309bdee" />

운전자의 차량의 상태를 실시간으로 확인할 수 있도록 시각적인 정보를 제공합니다.

1.  **정보 표시:** WiFi를 통해 수신한 고객 정보, 차량 속도, 거리, PWM 데이터를 LCD에 출력 
2.  **화면 전환:** 스위치(Switch) 버튼을 눌러 LCD에 표시되는 데이터 화면을 전환 
3.  **경고 시스템:** 안전 거리가 확보되지 않았을 때 LED 경고등 점등

---

## 4. 시연 영상 (Demonstration)

서버(Raspberry Pi), 클라이언트(STM32/Arduino), 그리고 DB가 실시간으로 연동되어 차량을 제어하는 실제 구동 모습



https://github.com/user-attachments/assets/a803227f-d855-40d4-9eee-1fd7f5608cb0



* **좌측 상단 (Server):** 각 클라이언트로부터 수신된 메시지 패킷 모니터링
* **우측 상단 (DB):** MariaDB에 실시간으로 적재되는 차량 주행 로그(속도, 거리, PWM 등)
* **좌측 하단 (Arduino):** 운전자용 대시보드(LCD)에 현재 상태 표시
* **우측 하단 (Smart Car):** 초음파 센서 감지에 따른 PID 속도 제어 및 실제 주행

---


##  5. 주요 기술

| 구성 요소 | 역할 및 기술 |
| :--- | :--- |
| **STM32F411RE** |DC 모터 PID 제어, 초음파 거리 측정, 블루투스 통신, 엔코더 센서 활용 |
| **Arduino** | 운전자 UI(LCD/LED/Switch) 구현, WiFi 모듈을 통한 데이터 파싱 |
| **Raspberry Pi** | TCP/IP 소켓 통신 서버 및 DB 연동 |
| **MariaDB** | 주행 기록 및 차량 상태 로그 관리용 데이터베이스 |
| **PID Algorithm** | 오차값(P), 적분(I), 미분(D)을 반영한 정밀 모터 속도 제어 |

---

##  6. 트러블 슈팅 (Troubleshooting)
**[모터 폭주 현상]**
* **현상:** 모터 구동 초기에는 PWM이 선형적으로 증가하며 안정적이었으나, 목표 속도에 근접하는 시점에서 PWM이 최대치(255)로 급증하며 모터가 폭주하는 현상 발생
* **원인:**
 1.  제어 로직에서 적분항 제약없이 누적되는 구조로 P항에 I항이 계속 더해져 err_I 값이 커짐
 2.  변화량 계산 시 (이전오차 - 현재오차)로 작성되어서 미분 수식의 오류
* **해결:**
    1. 정지 명령 시 적분 오차(`err_I`)를 즉시 초기화하도록 로직 수정
     2. 미분항 수식을 (현재오차-이전오차)를 수정
    3. 로그값을 분석하면서 조정한 결과, Pv = 4.0, Iv = 0.0155, Dv = 0.5 조합이 목표 속도 변화는 따라가면서 안정적인 응답을 보여 최종 게인으로 선정함


##  7. 개발후기
**1. 제어 알고리즘 이식 최적화**  
기존 Arduino 기반의 PID 제어 로직을 STM32(HAL Driver)로 이식하는 과정에서 단순한 코드복사가 아니라 MCU 하드웨어 특성에 맞는 최적화의 필요함을 배웠습니다. 특히 타이머 인터럽트를 적용해 제어 주기를 정밀화하고, 미분항의 수식 오류와 기존의 적분항 로직을 변경하는 과정에서 알고리즘 검증의 중요성을 깨달았습니다. 또한 튜닝을 하는 과정에서 단순한 값의 대입이 아니라 시스템 전반의 물리적 조건과 변수를 함께 고려해야 안정적으로 동작한다는 것을 깊이 이해하게 되었습니다.

**2. IoT 시스템 아키텍쳐 통합**  
개별 하드웨어(STM32, Arduino) 제어를 넘어, 여러 디바이스를 네트워크(Server, DB)로 연결하고 데이터를 통합 관리하는 전체 IoT 아키텍처를 설계하고 구현하는 역량을 길렀습니다.

---

